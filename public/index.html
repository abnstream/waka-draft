<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å’Œæ­Œãƒ‰ãƒ©ãƒ•ãƒˆ</title>
    <style>
        body { font-family: "Hiragino Mincho ProN", "Yu Mincho", serif; text-align: center; background-color: #fdfcf8; color: #333; margin: 0; padding-bottom: 50px;}
        .screen { display: none; padding: 20px; }
        .active { display: block; }
        
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px; border-radius: 4px; border: 1px solid #888; background: #fff;}
        button:hover { background: #eee; }
        input { padding: 8px; font-size: 16px; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card-btn {
            display: inline-block; margin: 5px; padding: 12px 18px;
            cursor: pointer; font-family: sans-serif; font-weight: bold;
            box-shadow: 2px 2px 2px rgba(0,0,0,0.1); border-radius: 6px;
        }
        .card-btn:hover { transform: translateY(-2px); box-shadow: 2px 4px 4px rgba(0,0,0,0.15); }
        .card-5 { background-color: #fff0f0; border: 2px solid #ff9999; color: #cc0000; }
        .card-7 { background-color: #f0f8ff; border: 2px solid #99ccff; color: #0000cc; }

        /* ã‚¹ãƒ­ãƒƒãƒˆ */
        #waka-slots { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap;}
        .slot {
            width: 100px; height: 140px; border: 2px dashed #aaa;
            display: flex; align-items: center; justify-content: center;
            background: #fff; writing-mode: vertical-rl; font-size: 18px;
            cursor: pointer;
        }
        .slot.filled { border-style: solid; background-color: #fff; }

        /* ç™ºè¡¨ã‚¨ãƒªã‚¢ */
        #presentation-area {
            background-color: #fff; border: 4px double #333; padding: 40px; margin: 20px auto;
            width: 80%; max-width: 600px; min-height: 400px;
            display: flex; flex-direction: row-reverse; justify-content: center; align-items: center; gap: 20px;
        }
        .waka-phrase {
            writing-mode: vertical-rl; font-size: 32px; line-height: 2; font-weight: bold;
            animation: fadeIn 1s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .author-name { font-size: 24px; margin-top: 20px; color: #555; }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
        #controller-panel {
            border: 2px solid #d32f2f; padding: 20px; background: #fff5f5; margin: 20px auto; max-width: 500px; border-radius: 8px;
        }
        .next-phrase-preview { font-size: 24px; font-weight: bold; color: #d32f2f; margin: 15px 0;}

        /* çµæœç™ºè¡¨ç”»é¢ */
        #results-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
        .result-card {
            background: #fff; border: 1px solid #ccc; box-shadow: 3px 3px 6px rgba(0,0,0,0.2);
            padding: 20px; width: 180px; min-height: 300px;
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .result-waka-content {
            flex-grow: 1; display: flex;
            /* ä¿®æ­£ï¼šrow-reverseã‚’å‰Šé™¤ã—ã¦æ­£ã—ã„é †åºã« */
            gap: 8px; writing-mode: vertical-rl;
            font-size: 18px; line-height: 1.5; font-weight: bold;
            margin-bottom: 20px; justify-content: center;
        }
        .result-author { font-size: 16px; color: #555; border-top: 1px solid #eee; padding-top: 10px; width: 100%; }
        .flower-mark {
            position: absolute; top: -10px; right: -10px;
            width: 40px; height: 40px; background: #ffcc00; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: #d32f2f; border: 2px solid #d32f2f;
            transform: rotate(15deg); box-shadow: 2px 2px 2px rgba(0,0,0,0.2);
        }

    </style>
</head>
<body>
    <h1>å’Œæ­Œãƒ‰ãƒ©ãƒ•ãƒˆ</h1>

    <div id="lobby-screen" class="screen active">
        <h3>åå‰ã‚’å…¥åŠ›ã—ã¦å‚åŠ </h3>
        <input type="text" id="username" placeholder="é›…å·ï¼ˆåå‰ï¼‰">
        <button onclick="joinGame()">ã„ã–ã€å‚ã‚‹</button>
        <ul id="player-list" style="list-style:none; padding:0;"></ul>
        <div id="start-area" style="display:none;">
            <button onclick="sendStartSignal()" style="background:#ffcccc;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>
    </div>

    <div id="input-screen" class="screen">
        <h3>è¨€è‘‰ã‚’å…¥åŠ›</h3>
        <button onclick="autoFill()">è‡ªå‹•å…¥åŠ›ï¼ˆç™¾äººä¸€é¦–ï¼‰</button>
        <div id="inputs">
            <p style="color:#cc0000; font-weight:bold;">äº”æ–‡å­—ï¼ˆèµ¤ï¼‰</p>
            <input class="w5"><input class="w5"><input class="w5">
            <p style="color:#0000cc; font-weight:bold;">ä¸ƒæ–‡å­—ï¼ˆé’ï¼‰</p>
            <input class="w7"><input class="w7"><input class="w7"><input class="w7">
        </div>
        <button onclick="sendPack()">ãƒ‘ãƒƒã‚¯é€ä¿¡</button>
        <div id="wait-msg"></div>
    </div>

    <div id="draft-screen" class="screen">
        <h3>å›ã£ã¦ããŸè¨€è‘‰</h3>
        <div id="pack-area"></div>
        <hr>
        <h4>æ‰‹å…ƒã®è¨€è‘‰</h4>
        <div id="my-hand-display" style="font-size: 14px; color: #666;"></div>
    </div>

    <div id="compose-screen" class="screen">
        <h2 style="color:red;">ã‚ãªãŸã®ç•ªã§ã™ï¼</h2>
        <p>è¨€è‘‰ã‚’é¸ã‚“ã§é…ç½®ã—ã¦ãã ã•ã„ã€‚</p>
        <div id="waka-slots">
            <div class="slot" onclick="clearSlot(0)" id="slot-0">ï¼ˆäº”ï¼‰</div>
            <div class="slot" onclick="clearSlot(1)" id="slot-1">ï¼ˆä¸ƒï¼‰</div>
            <div class="slot" onclick="clearSlot(2)" id="slot-2">ï¼ˆäº”ï¼‰</div>
            <div class="slot" onclick="clearSlot(3)" id="slot-3">ï¼ˆä¸ƒï¼‰</div>
            <div class="slot" onclick="clearSlot(4)" id="slot-4">ï¼ˆä¸ƒï¼‰</div>
        </div>
        <button onclick="readyToPresent()">ã“ã‚Œã§ç™ºè¡¨ã¸é€²ã‚€</button>
        <div id="compose-hand-area"></div>
    </div>

    <div id="controller-screen" class="screen">
        <h2>ç™ºè¡¨ä¸­...</h2>
        <div id="controller-panel">
            <p>å£°ã«å‡ºã—ã¦èª­ã¿ä¸Šã’ãªãŒã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
            <hr>
            <p>æ¬¡ã¯...</p>
            <div id="preview-text" class="next-phrase-preview">...</div>
            <br>
            <button id="reveal-btn" onclick="revealNext()" style="font-size: 24px; padding: 20px; width:100%;">è¡¨ç¤ºã™ã‚‹ï¼</button>
        </div>
    </div>

    <div id="reveal-screen" class="screen">
        <h3 id="reveal-status-msg">å¾…æ©Ÿä¸­...</h3>
        <div id="presentation-area"></div>
        <div id="author-display" class="author-name"></div>
    </div>

    <div id="end-screen" class="screen">
        <h2>ã€ é¸å¥ä¼šï¼ˆçµæœç™ºè¡¨ï¼‰ ã€‘</h2>
        <p>å…¨å“¡ã®å’Œæ­ŒãŒå‡ºæƒã„ã¾ã—ãŸã€‚</p>
        <div id="results-container"></div>
        <br><br>
        <button onclick="location.reload()" style="background:#ffccaa;">å®´ã‚’çµ‚äº†ã—ã¦æœ€åˆã«æˆ»ã‚‹</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myHand = []; 
        let composedWaka = [null, null, null, null, null];
        let revealIndex = 0;

        // --- â˜…åŠ¹æœéŸ³ã®èª­ã¿è¾¼ã¿ ---
        // public/sounds/ ãƒ•ã‚©ãƒ«ãƒ€ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦ãã ã•ã„
        const audioStart = new Audio('/sounds/start.mp3');
        const audioTurn = new Audio('/sounds/turn.mp3');
        
        // éŸ³é‡ã‚’å°‘ã—èª¿æ•´ï¼ˆãŠå¥½ã¿ã§ï¼‰
        audioStart.volume = 0.5;
        audioTurn.volume = 0.5;

        // SEå†ç”Ÿç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function playSE(audioObj) {
            // ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã§å†ç”Ÿã§ããªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã™
            audioObj.currentTime = 0; // é ­å‡ºã—
            audioObj.play().catch(e => console.log("SEå†ç”Ÿã‚¨ãƒ©ãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾…ã¡):", e));
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function getColorClass(cardObj) {
            if (!cardObj) return "";
            return cardObj.type === 7 ? 'card-7' : 'card-5';
        }

        // --- å—ä¿¡å‡¦ç† ---
        socket.on('update_player_list', (names) => {
            document.getElementById('player-list').innerHTML = names.map(n => `<li>${n}</li>`).join("");
        });
        socket.on('error_msg', msg => alert(msg));
        
        // â˜…ã‚²ãƒ¼ãƒ é–‹å§‹SE
        socket.on('move_to_input', () => {
            playSE(audioStart);
            showScreen('input-screen');
        });

        // â˜…ãƒ‰ãƒ©ãƒ•ãƒˆ ã‚¿ãƒ¼ãƒ³é€šçŸ¥SE
        socket.on('next_draft_turn', (data) => {
            // ã‚‚ã—ãƒ‘ãƒƒã‚¯ã®ä¸­èº«ãŒã‚ã‚‹ãªã‚‰ã€ãã‚Œã¯è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³
            if(data.pack.length > 0) {
                playSE(audioTurn);
            }
            showScreen('draft-screen');
            const area = document.getElementById('pack-area');
            area.innerHTML = "";
            if(data.pack.length === 0) area.innerHTML = "ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¾…ã¡...";
            else {
                data.pack.forEach((cardObj, idx) => {
                    const btn = document.createElement('button');
                    btn.className = `card-btn ${getColorClass(cardObj)}`;
                    btn.innerText = cardObj.text;
                    btn.onclick = () => pickCard(idx);
                    area.appendChild(btn);
                });
            }
            document.getElementById('my-hand-display').innerText = data.hand.map(c => c.text).join(" / ");
        });

        socket.on('start_reveal_phase', () => {
            showScreen('reveal-screen');
            resetRevealScreen("ç™ºè¡¨ã®æº–å‚™ä¸­...");
        });

        socket.on('update_reveal_status', (data) => {
            if(!data.isMe) {
                showScreen('reveal-screen');
                resetRevealScreen(`${data.currentName} ã•ã‚“ãŒã€æ•´ãˆã¦ã„ã¾ã™...`);
            }
        });

        // â˜…ç™ºè¡¨ è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³é€šçŸ¥SE
        socket.on('your_reveal_turn', (data) => {
            playSE(audioTurn); // è‡ªåˆ†ã®ç•ªãŒæ¥ãŸã‚‰é³´ã‚‰ã™
            
            myHand = data.hand;
            composedWaka = [null, null, null, null, null];
            showScreen('compose-screen');
            renderComposeHand();
            renderSlots();
        });

        socket.on('announce_start', (data) => {
            const isController = document.getElementById('controller-screen').classList.contains('active');
            if (!isController) {
                showScreen('reveal-screen');
                resetRevealScreen("ã€ç™ºè¡¨ã€‘");
                document.getElementById('author-display').innerText = `è© ã¿äººï¼š${data.name}`;
            }
        });

        socket.on('show_step', (cardObj) => {
            const area = document.getElementById('presentation-area');
            const span = document.createElement('span');
            span.className = 'waka-phrase';
            span.innerText = cardObj.text;
            area.appendChild(span); 
        });

        socket.on('game_over', (results) => {
            showScreen('end-screen');
            const container = document.getElementById('results-container');
            container.innerHTML = ""; 

            results.forEach(item => {
                const card = document.createElement('div');
                card.className = 'result-card';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'result-waka-content';
                
                item.waka.forEach(wordObj => {
                    const span = document.createElement('span');
                    span.innerText = wordObj.text;
                    contentDiv.appendChild(span);
                });

                const nameDiv = document.createElement('div');
                nameDiv.className = 'result-author';
                nameDiv.innerText = item.name;

                const flower = document.createElement('div');
                flower.className = 'flower-mark';
                flower.innerText = "ğŸ’®";

                card.appendChild(flower);
                card.appendChild(contentDiv);
                card.appendChild(nameDiv);
                container.appendChild(card);
            });
        });

        // --- æ“ä½œå‡¦ç† ---
        function joinGame() {
            const name = document.getElementById('username').value;
            if(!name) return;
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰ãŒã‚ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§
            // ä¸€åº¦ç„¡éŸ³ã§å†ç”Ÿã—ã¦ãŠãã¨ã€å¾Œã§è‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã«ãããªã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯
            // ï¼ˆä»Šå›ã¯ç°¡æ˜“çš„ã«å®Ÿè£…ï¼‰
            socket.emit('join_game', name);
            document.getElementById('start-area').style.display = 'block';
        }
        function sendStartSignal() { socket.emit('start_game_signal'); }

        function sendPack() {
            const w5 = Array.from(document.querySelectorAll('.w5')).map(i => ({ text: i.value, type: 5 }));
            const w7 = Array.from(document.querySelectorAll('.w7')).map(i => ({ text: i.value, type: 7 }));
            socket.emit('submit_pack', [...w5, ...w7]);
            document.getElementById('inputs').innerHTML = "";
            document.getElementById('wait-msg').innerText = "å¾…æ©Ÿä¸­...";
        }

        function pickCard(index) {
            socket.emit('pick_card', index);
            document.getElementById('pack-area').innerHTML = "å¾…æ©Ÿä¸­...";
        }

        function addToSlot(cardObj, handIndex) {
            const emptyIndex = composedWaka.findIndex(w => w === null);
            if (emptyIndex === -1) return;
            composedWaka[emptyIndex] = cardObj;
            myHand[handIndex] = null;
            renderSlots();
            renderComposeHand();
        }
        function clearSlot(slotIndex) {
            const cardObj = composedWaka[slotIndex];
            if (!cardObj) return;
            const emptyHandIdx = myHand.findIndex(h => h === null);
            if (emptyHandIdx !== -1) myHand[emptyHandIdx] = cardObj;
            else myHand.push(cardObj);
            composedWaka[slotIndex] = null;
            renderSlots();
            renderComposeHand();
        }
        
        function renderSlots() {
            const labels = ["ï¼ˆäº”ï¼‰", "ï¼ˆä¸ƒï¼‰", "ï¼ˆäº”ï¼‰", "ï¼ˆä¸ƒï¼‰", "ï¼ˆä¸ƒï¼‰"];
            composedWaka.forEach((cardObj, idx) => {
                const el = document.getElementById(`slot-${idx}`);
                el.className = 'slot'; 
                if (cardObj) { 
                    el.innerText = cardObj.text; 
                    el.classList.add('filled');
                    el.classList.add(getColorClass(cardObj));
                } else { 
                    el.innerText = labels[idx]; 
                }
            });
        }
        
        function renderComposeHand() {
            const area = document.getElementById('compose-hand-area');
            area.innerHTML = "";
            myHand.forEach((cardObj, idx) => {
                if(cardObj === null) return;
                const btn = document.createElement('button');
                btn.className = `card-btn ${getColorClass(cardObj)}`;
                btn.innerText = cardObj.text;
                btn.onclick = () => addToSlot(cardObj, idx);
                area.appendChild(btn);
            });
        }

        function readyToPresent() {
            if (composedWaka.includes(null)) {
                alert("è¨€è‘‰ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã›ã‚“ï¼");
                return;
            }
            socket.emit('ready_to_present', composedWaka);
            revealIndex = 0;
            showScreen('controller-screen');
            updateControllerUI();
        }

        function revealNext() {
            if (revealIndex < composedWaka.length) {
                const cardObj = composedWaka[revealIndex];
                socket.emit('reveal_step', cardObj);
                revealIndex++;
                updateControllerUI();
            } else {
                socket.emit('finish_turn');
            }
        }

        function updateControllerUI() {
            const btn = document.getElementById('reveal-btn');
            const preview = document.getElementById('preview-text');
            if (revealIndex < composedWaka.length) {
                const cardObj = composedWaka[revealIndex];
                preview.innerText = `æ¬¡ã¯... ã€Œ${cardObj.text}ã€`;
                preview.style.color = cardObj.type === 7 ? '#0000cc' : '#cc0000';
                btn.innerText = "è¡¨ç¤ºã™ã‚‹ï¼";
                btn.disabled = false;
                btn.style.backgroundColor = "#fff";
            } else {
                preview.innerText = "å…¨ã¦è¡¨ç¤ºã—ã¾ã—ãŸ";
                preview.style.color = "#333";
                btn.innerText = "ç™ºè¡¨ã‚’çµ‚äº†ã—ã¦æ¬¡ã®äººã¸";
                btn.style.backgroundColor = "#ddd";
            }
        }

        function resetRevealScreen(msg) {
            document.getElementById('reveal-status-msg').innerText = msg;
            document.getElementById('presentation-area').innerHTML = "";
            document.getElementById('author-display').innerText = "";
        }

        const WORDS_5 = [
            "ç§‹ã®ç”°ã®", "æ˜¥éãã¦", "è¶³å¼•ãã®", "ç”°å­ã®æµ¦ã«", "å¥¥å±±ã«",
            "å¤©ã®åŸ", "èŠ±ã®è‰²ã¯", "ã“ã‚Œã‚„ã“ã®", "ã‚ãŸã®åŸ", "å¤©ã¤é¢¨",
            "ç­‘æ³¢å¶ºã®", "é™¸å¥¥ã®", "å›ãŒãŸã‚", "ç«‹ã¡åˆ¥ã‚Œ", "åƒæ—©ã¶ã‚‹",
            "ä½ã®æ±Ÿã®", "é›£æ³¢æ½Ÿ", "ã‚ã³ã¬ã‚Œã°", "ä»Šæ¥ã‚€ã¨", "ã²ã•ã‹ãŸã®",
            "èª°ã‚’ã‹ã‚‚", "äººã¯ã„ã•", "å¤ã®å¤œã¯", "ç™½éœ²ã«", "æµ…èŒ…ç”Ÿã®",
            "å¿ã¶ã‚Œã©", "æ‹ã™ã¦ãµ", "å¥‘ã‚Šããª", "ç€¬ã‚’æ—©ã¿", "æ·¡è·¯å³¶"
        ];
        const WORDS_7 = [
            "ã‹ã‚Šã»ã®åºµã®", "è¡£ã»ã™ã¦ãµ", "å±±é³¥ã®å°¾ã®", "ã†ã¡å‡ºã§ã¦è¦‹ã‚Œã°", "ç´…è‘‰è¸ã¿åˆ†ã‘",
            "ãµã‚Šã•ã‘è¦‹ã‚Œã°", "ç§»ã‚Šã«ã‘ã‚Šãª", "è¡Œãã‚‚å¸°ã‚‹ã‚‚", "å…«åå³¶ã‹ã‘ã¦", "é›²ã®é€šã²è·¯",
            "å¶ºã‚ˆã‚Šè½ã¤ã‚‹", "ä¿¡å¤«ã‚‚ã¢ãšã‚Š", "æ˜¥ã®é‡ã«å‡ºã§ã¦", "ã„ãªã°ã®å±±ã®", "ç¥ä»£ã‚‚èã‹ãš",
            "å²¸ã«å¯„ã‚‹æ³¢", "çŸ­ãè‘¦ã®", "ä»Šã¯ãŸåŒã˜", "è¨€ã²ã—ã°ã‹ã‚Šã«", "å…‰ã®ã©ã‘ã",
            "çŸ¥ã‚‹äººã«ã›ã‚€", "å¿ƒã‚‚çŸ¥ã‚‰ãš", "ã¾ã å®µãªãŒã‚‰", "é¢¨ã®å¹ãã—ã", "å°é‡ã®ç¯ åŸ",
            "è‰²ã«å‡ºã§ã«ã‘ã‚Š", "ã‚ãŒåã¯ã¾ã ã", "ã‹ãŸã¿ã«è¢–ã‚’", "å²©ã«ã›ã‹ã‚‹ã‚‹", "ã‹ã‚ˆãµåƒé³¥ã®"
        ];
        function autoFill() {
            document.querySelectorAll('.w5').forEach(input => {
                input.value = WORDS_5[Math.floor(Math.random() * WORDS_5.length)];
            });
            document.querySelectorAll('.w7').forEach(input => {
                input.value = WORDS_7[Math.floor(Math.random() * WORDS_7.length)];
            });
        }
    </script>
</body>
</html>